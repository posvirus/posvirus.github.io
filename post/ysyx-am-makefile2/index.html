<!DOCTYPE html>
<html lang="en-us">

<head>
    <title>
AM Makefile解读（2） | Posvirus&#39; Blog
</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="YSYX学习笔记：AM Makefile解读（2）">

<meta name="generator" content="Hugo 0.148.1">


<link rel="canonical" href="https://posvirus.github.io/post/ysyx-am-makefile2/" >




<link href="/css/style.min.bd4aca9b9a5f6ce86d9d6ab6e6757498b0a0c742d1963f144557e59ca9d2da00.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />



</head>

<body>

    <div class="flexWrapper">
        <header class="headerWrapper">
    <div class="header">
        <div>
            <a class="terminal" href="/">
                <span>posvirus@github.io ~ $</span>
            </a>
        </div>
        <input class="side-menu" type="checkbox" id="side-menu">
        <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
        <nav class="headerLinks">
            <ul>
                
                <li>
                    <a href="https://posvirus.github.io/about" title="" >
                        ~/about</a>
                </li>
                
                <li>
                    <a href="https://posvirus.github.io/blog" title="" >
                        ~/blog</a>
                </li>
                
            </ul>
        </nav>
    </div>
</header>


        <div class="content">
            <main class="main">
                
<div class="postWrapper">
    <h1>AM Makefile解读（2）</h1>
    
    	<p>YSYX学习笔记：AM Makefile解读（2）</p>
    
    
    <section class="postMetadata">
        <dl>
            
                
<dt>tags</dt>
<dd><span></span>
    <a href="/tags/am/">#AM</a><span></span>
    <a href="/tags/makefile/">#Makefile</a></dd>
            
            
            
                
<dt>categories</dt>
<dd><span></span>
    <a href="/categories/ysyx/">YSYX</a></dd>
            
            
                <dt>published</dt>
                
                <dd><time datetime="2025-08-23">August 23, 2025</time></dd>
            
            
                <dt>reading time</dt>
                <dd>2 minutes</dd>
            
        </dl>
    </section>
    
    <div>
        <p><strong>Created by posvirus, August 23rd, 2025</strong></p>
<h3 id="1-native可执行文件的生成">1. native可执行文件的生成</h3>
<p>在AM Makefile中，我们会通过：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#75715e">### Paste in arch-specific configurations (e.g., from `scripts/x86_64-qemu.mk`)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-include</span> <span style="color:#66d9ef">$(</span>AM_HOME<span style="color:#66d9ef">)</span><span style="color:#960050;background-color:#1e0010">/scripts/</span><span style="color:#66d9ef">$(</span>ARCH<span style="color:#66d9ef">)</span><span style="color:#960050;background-color:#1e0010">.mk</span>
</span></span></code></pre></div><p>包含架构相关的Makefile，当我们指定<code>ARCH=native</code>时，包含的Makefile内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span>AM_SRCS <span style="color:#f92672">:=</span> native/trm.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/ioe.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/cte.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/trap.S <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/vme.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/mpe.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/platform.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/ioe/input.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/ioe/timer.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/ioe/gpu.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/ioe/uart.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/ioe/audio.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>           native/ioe/disk.c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>
</span></span><span style="display:flex;"><span>CFLAGS  <span style="color:#f92672">+=</span> -fpie <span style="color:#66d9ef">$(</span>shell sdl2-config --cflags<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>ASFLAGS <span style="color:#f92672">+=</span> -fpie -pie
</span></span><span style="display:flex;"><span>comma <span style="color:#f92672">=</span> ,
</span></span><span style="display:flex;"><span>LDFLAGS_CXX <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>addprefix -Wl<span style="color:#66d9ef">$(</span>comma<span style="color:#66d9ef">)</span>, <span style="color:#66d9ef">$(</span>LDFLAGS<span style="color:#66d9ef">))</span> -pie -ldl <span style="color:#66d9ef">$(</span>shell sdl2-config --libs<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">run</span><span style="color:#f92672">:</span> image
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">$(</span>IMAGE<span style="color:#66d9ef">)</span>.elf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gdb</span><span style="color:#f92672">:</span> image
</span></span><span style="display:flex;"><span>	gdb -ex <span style="color:#e6db74">&#34;handle SIGUSR1 SIGUSR2 SIGSEGV noprint nostop&#34;</span> <span style="color:#66d9ef">$(</span>IMAGE<span style="color:#66d9ef">)</span>.elf
</span></span></code></pre></div><p>首先，该Makefile会定义<code>AM_SRCS</code>，包含GNU/Linux默认的运行时环境<code>native</code>用于实现AM API的所有源文件，该变量会在<code>am</code>路径下的Makefile中被使用，作为<code>SRC</code>进行编译：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span>NAME     <span style="color:#f92672">:=</span> am
</span></span><span style="display:flex;"><span>SRCS      <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>addprefix src/, <span style="color:#66d9ef">$(</span>AM_SRCS<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span>INC_PATH <span style="color:#f92672">+=</span> <span style="color:#66d9ef">$(</span>AM_HOME<span style="color:#66d9ef">)</span>/am/src
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">include</span> <span style="color:#66d9ef">$(</span>AM_HOME<span style="color:#66d9ef">)</span><span style="color:#960050;background-color:#1e0010">/Makefile</span>
</span></span></code></pre></div><p>随后，该Makefile会补充<code>native</code>架构下对应的编译选项，这部分我们暂且不作说明。</p>
<p>最后，该Makefile定义了<code>run</code>与<code>gdb</code>两个目标，分别用于直接执行<code>$(IMAGE).elf</code>与调试执行<code>$(IMAGE).elf</code>。</p>
<h3 id="2-makefile的错误码">2. Makefile的错误码</h3>
<p>使用如下指令在<code>native</code>架构下执行测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make ARCH<span style="color:#f92672">=</span>native ALL<span style="color:#f92672">=</span>$PROGRAM run
</span></span></code></pre></div><p>如若执行失败，则会返回：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: *** <span style="color:#f92672">[</span>run<span style="color:#f92672">]</span> Error <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>此处我们将分析这里错误码1的来源：首先，我们知道测试程序的正确与错误是通过程序中的<code>check()</code>函数实现的，于是我们可查看该函数的实现，在<code>trap.h</code>中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span>(<span style="color:#66d9ef">bool</span> cond) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cond) <span style="color:#a6e22e">halt</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>据此可观察到，当条件<code>cond</code>为<code>false</code>时，函数会调用<code>halt(1)</code>，该函数应该是控制错误码的核心函数，于是我们寻找该函数的定义，在AM的<code>trm.c</code>中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">halt</span>(<span style="color:#66d9ef">int</span> code) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>fmt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Exit code = 40h</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> fmt; <span style="color:#f92672">*</span>p; p<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> ch <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">||</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;4&#39;</span>) {
</span></span><span style="display:flex;"><span>      ch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0123456789abcdef&#34;</span>[(code <span style="color:#f92672">&gt;&gt;</span> (ch <span style="color:#f92672">-</span> <span style="color:#e6db74">&#39;0&#39;</span>)) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xf</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">putch</span>(ch);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__am_exit_platform</span>(code);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">putstr</span>(<span style="color:#e6db74">&#34;Should not reach here!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>不难发现，<code>halt()</code>函数的<code>code</code>参数即用于控制错误码。为验证这一点，我们不妨将<code>check()</code>函数中的<code>halt(1)</code>改为<code>halt(3)</code>，再次运行某个程序，并打印对应的错误输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Building add-run [native]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Building am-archive [native]</span>
</span></span><span style="display:flex;"><span>+ CC src/native/cte.c
</span></span><span style="display:flex;"><span>+ CC src/native/vme.c
</span></span><span style="display:flex;"><span>+ CC src/native/mpe.c
</span></span><span style="display:flex;"><span>+ CC src/native/platform.c
</span></span><span style="display:flex;"><span>+ CC src/native/ioe/audio.c
</span></span><span style="display:flex;"><span>+ AR -&gt; build/am-native.a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Building klib-archive [native]</span>
</span></span><span style="display:flex;"><span>+ CC src/stdio.c
</span></span><span style="display:flex;"><span>+ CC src/cpp.c
</span></span><span style="display:flex;"><span>+ CC src/stdlib.c
</span></span><span style="display:flex;"><span>+ CC src/string.c
</span></span><span style="display:flex;"><span>+ AR -&gt; build/klib-native.a
</span></span><span style="display:flex;"><span>+ CC tests/add.c
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Creating image [native]</span>
</span></span><span style="display:flex;"><span>+ LD -&gt; build/add-native.elf
</span></span><span style="display:flex;"><span>Exit code <span style="color:#f92672">=</span> 03h
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: *** <span style="color:#f92672">[</span>/home/chenwy/ysyx-workbench/abstract-machine/scripts/native.mk:21: run<span style="color:#f92672">]</span> Error <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>test list <span style="color:#f92672">[</span><span style="color:#ae81ff">1</span> item<span style="color:#f92672">(</span>s<span style="color:#f92672">)]</span>: add
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>           add<span style="color:#f92672">]</span> ***FAIL***
</span></span></code></pre></div><p>此时可观察到，程序的错误码输出已变成3。</p>
<h3 id="3-klib的链接">3. klib的链接</h3>
<p>框架代码编译到<code>native</code>的时候默认链接到glibc, 我们需要把这些库函数的调用链接到我们编写的klib来进行测试. 我们可以通过在<code>klib.h</code> 中通过定义宏<code>__NATIVE_USE_KLIB__</code>来把库函数链接到klib。该功能的实现原理如下：</p>
<ul>
<li><strong>编译阶段：</strong> 在klib的库函数实现中包含如下字段：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#if !defined(__ISA_NATIVE__) || defined(__NATIVE_USE_KLIB__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><ul>
<li>该字段表明，如果程序在非<code>native</code>架构下编译，或在<code>native</code>架构下编译且定义了<code>__NATIVE_USE_KLIB__</code>，则译该文件中的函数实现。</li>
<li><strong>链接阶段：</strong> 链接器会按顺序处理目标文件和库。自定义实现的符号会优先被链接，而不是系统标准库中的相同符号（因为链接器默认先处理显式指定的目标文件，后处理库）。</li>
</ul>
    </div>
</div>

            </main>
        </div>


        <footer class="footer">
    
        <span>
            © 2025 Posvirus&#39; Blog, Built with
            <a href="https://gohugo.io" class="footerLink">Hugo</a> and
            <a href="https://github.com/LordMathis/hugo-theme-nightfall" class="footerLink">Nightfall</a> theme
        </span>
    
</footer>
    </div>

</body>

</html>