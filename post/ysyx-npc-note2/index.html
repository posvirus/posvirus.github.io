<!DOCTYPE html>
<html lang="en-us">

<head>
    <title>
NPC实现时的注意事项（2） | Posvirus&#39; Blog
</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="YSYX学习笔记：NPC实现时的注意事项（2）">

<meta name="generator" content="Hugo 0.148.1">


<link rel="canonical" href="https://posvirus.github.io/post/ysyx-npc-note2/" >




<link href="/css/style.min.bd4aca9b9a5f6ce86d9d6ab6e6757498b0a0c742d1963f144557e59ca9d2da00.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />



</head>

<body>

    <div class="flexWrapper">
        <header class="headerWrapper">
    <div class="header">
        <div>
            <a class="terminal" href="/">
                <span>posvirus@github.io ~ $</span>
            </a>
        </div>
        <input class="side-menu" type="checkbox" id="side-menu">
        <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
        <nav class="headerLinks">
            <ul>
                
                <li>
                    <a href="https://posvirus.github.io/about" title="" >
                        ~/about</a>
                </li>
                
                <li>
                    <a href="https://posvirus.github.io/blog" title="" >
                        ~/blog</a>
                </li>
                
            </ul>
        </nav>
    </div>
</header>


        <div class="content">
            <main class="main">
                
<div class="postWrapper">
    <h1>NPC实现时的注意事项（2）</h1>
    
    	<p>YSYX学习笔记：NPC实现时的注意事项（2）</p>
    
    
    <section class="postMetadata">
        <dl>
            
                
<dt>tags</dt>
<dd><span></span>
    <a href="/tags/npc/">#NPC</a><span></span>
    <a href="/tags/nemu/">#NEMU</a></dd>
            
            
            
                
<dt>categories</dt>
<dd><span></span>
    <a href="/categories/ysyx/">YSYX</a></dd>
            
            
                <dt>published</dt>
                
                <dd><time datetime="2025-09-30">September 30, 2025</time></dd>
            
            
                <dt>reading time</dt>
                <dd>4 minutes</dd>
            
        </dl>
    </section>
    
    <div>
        <p><strong>Created by posvirus, September 30th, 2025</strong></p>
<p>此处，我们主要关注向NPC中集成DiffTest时的一些注意事项：</p>
<h3 id="1-cpu状态的存储">1. CPU状态的存储</h3>
<p>在运行DiffTest时，我们需要比较REF与DUT的CPU的状态是否一致，而NPC先前未定义存储CPU状态的结构体（因为CPU的状态实际存储在RTL代码中），为方便DiffTest的传参，我们补充定义存储CPU状态的结构体<code>CPU_state</code>，以及它对应的初始化函数与状态同步函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  word_t grf[MUXDEF(CONFIG_RVE, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>)];
</span></span><span style="display:flex;"><span>  vaddr_t pc;
</span></span><span style="display:flex;"><span>} CPU_state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CPU_state cpu; <span style="color:#75715e">// defining struct facilitates parameter passing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">load_cpu</span>(Vtop<span style="color:#f92672">*</span> top) {
</span></span><span style="display:flex;"><span>  cpu.pc <span style="color:#f92672">=</span> top<span style="color:#f92672">-&gt;</span>inst_addr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> temp_grf;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> MUXDEF(CONFIG_RVE, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    gpr((<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>)i, <span style="color:#f92672">&amp;</span>temp_grf);
</span></span><span style="display:flex;"><span>    cpu.grf[i] <span style="color:#f92672">=</span> (word_t)temp_grf;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// the NPC RegisterFile has no reset signal, 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// so the initial value of gpr need to be given manually
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_cpu</span>() {
</span></span><span style="display:flex;"><span>  cpu.pc <span style="color:#f92672">=</span> RESET_VECTOR;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> MUXDEF(CONFIG_RVE, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    cpu.grf[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里，我们首先定义了<code>load_cpu()</code>函数，它会将当前CPU模块中的PC寄存器与寄存器堆的值传递至<code>cpu</code>中。其次，我们还补充定义了<code>init_cpu()</code>函数，这是因为，目前我们在<code>init_monitor()</code>函数中进行DiffTest的初始化，而该函数在主函数中会先于系统仿真复位函数执行，为保证<code>cpu</code>可以正确获取CPU模块复位的状态，我们需要手动为<code>cpu</code>中的字段赋值。</p>
<h3 id="2-rv32e指令集的适配">2. RV32E指令集的适配</h3>
<p>NEMU的Kconfig中有一个<code>RVE</code>的选项，用于将NEMU的指令集架构指定为RV32E，选中该选项后，会在生成<code>CONFIG_RVE</code>的宏定义，为使NEMU适配RV32E指令集，我们需要对NEMU代码进行相应更改，修改主要集中于对NEMU的寄存器堆访问，需要根据<code>CONFIG_RVE</code>判断寄存器的总数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">isa_reg_display</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> reg_cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; reg_cnt <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">MUXDEF</span>(CONFIG_RVE, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>); reg_cnt <span style="color:#f92672">=</span> reg_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08x</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, regs[reg_cnt], <span style="color:#a6e22e">gpr</span>(reg_cnt), <span style="color:#a6e22e">gpr</span>(reg_cnt));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// extra print PC register
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pc</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08x</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cpu.pc, cpu.pc);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">word_t</span> <span style="color:#a6e22e">isa_reg_str2val</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">bool</span> <span style="color:#f92672">*</span>success) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> reg_cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; reg_cnt <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">MUXDEF</span>(CONFIG_RVE, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>); reg_cnt <span style="color:#f92672">=</span> reg_cnt <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(s, regs[reg_cnt]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>success <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gpr</span>(reg_cnt);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// extra find pc register
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(s, <span style="color:#e6db74">&#34;pc&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>success <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> cpu.pc;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>success <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;register %s not found!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, s);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">isa_difftest_checkregs</span>(CPU_state <span style="color:#f92672">*</span>ref_r, <span style="color:#66d9ef">vaddr_t</span> pc) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> reg_num <span style="color:#f92672">=</span> <span style="color:#a6e22e">MUXDEF</span>(CONFIG_RVE, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> regs[];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> reg_num; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">difftest_check_reg</span>(regs[i], pc, ref_r<span style="color:#f92672">-&gt;</span>gpr[i], cpu.gpr[i])) <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">difftest_check_reg</span>(<span style="color:#e6db74">&#34;pc&#34;</span>, pc, ref_r<span style="color:#f92672">-&gt;</span>pc, cpu.pc)) <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3-nemu作为ref的自动化编译">3. NEMU作为REF的自动化编译</h3>
<p>在集成DiffTest时，我们需要将NEMU编译成动态库文件，并在NPC中动态链接该动态库文件，从而实现NEMU作为REF的DiffTest。但是，我们实际上不希望在每次运行NPC的DiffTest时，还要进入NEMU的目录下手动修改NEMU的配置并编译动态库文件，我们希望的一个理想的操作流是：</p>
<ul>
<li>在NPC的Kconfig中使能DiffTest后，构建NPC时会自动配置NEMU并编译NEMU的动态库文件。</li>
<li>NEMU的配置在NPC运行DiffTest后不应发生任何更改。</li>
</ul>
<p>为此，我们实现如下的Makefile：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">define</span> <span style="color:#960050;background-color:#1e0010">remove_quote</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">$(</span>strip <span style="color:#66d9ef">$(</span>subst &#34;,,<span style="color:#66d9ef">$(</span>1<span style="color:#66d9ef">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">endef</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ifdef</span> <span style="color:#960050;background-color:#1e0010">CONFIG_DIFFTEST</span>
</span></span><span style="display:flex;"><span>DIFF_REF_PATH <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>NEMU_HOME<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>DIFF_REF_SO <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>NEMU_HOME<span style="color:#66d9ef">)</span>/build/<span style="color:#66d9ef">$(</span>call remove_quote,<span style="color:#66d9ef">$(</span>CONFIG_ISA<span style="color:#66d9ef">))</span>-<span style="color:#66d9ef">$(</span>call remove_quote,<span style="color:#66d9ef">$(</span>CONFIG_DIFFTEST_REF_NAME<span style="color:#66d9ef">))</span>-<span style="color:#66d9ef">$(</span>call remove_quote,<span style="color:#66d9ef">$(</span>CONFIG_ENGINE<span style="color:#66d9ef">))</span>-so
</span></span><span style="display:flex;"><span>MKFLAGS <span style="color:#f92672">=</span> GUEST_ISA<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>call remove_quote,<span style="color:#66d9ef">$(</span>CONFIG_ISA<span style="color:#66d9ef">))</span> SHARE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ENGINE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>call remove_quote,<span style="color:#66d9ef">$(</span>CONFIG_ENGINE<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span>ARGS_DIFF <span style="color:#f92672">=</span> --diff<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>DIFF_REF_SO<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Backup and restore NEMU config files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NEMU_AUTO_CONF <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>NEMU_HOME<span style="color:#66d9ef">)</span>/include/config/auto.conf
</span></span><span style="display:flex;"><span>NEMU_AUTOCONF_H <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>NEMU_HOME<span style="color:#66d9ef">)</span>/include/generated/autoconf.h
</span></span><span style="display:flex;"><span>NEMU_AUTO_CONF_BK <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>NEMU_HOME<span style="color:#66d9ef">)</span>/include/config/auto.conf.bk
</span></span><span style="display:flex;"><span>NEMU_AUTOCONF_H_BK <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>NEMU_HOME<span style="color:#66d9ef">)</span>/include/generated/autoconf.h.bk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">backup-nemu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	@echo <span style="color:#e6db74">&#34;Backing up NEMU config files...&#34;</span>
</span></span><span style="display:flex;"><span>	@if <span style="color:#f92672">[</span> -f <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		cp <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF_BK<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_TARGET_NATIVE_ELF/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_TRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_ITRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_MTRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_FTRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_EXPR_TEST/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_DIFFTEST/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^CONFIG_ISA/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		echo <span style="color:#e6db74">&#34;CONFIG_ISA=\&#34;riscv32\&#34;&#34;</span> &gt;&gt; <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		echo <span style="color:#e6db74">&#34;CONFIG_ISA_riscv=y&#34;</span> &gt;&gt; <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>CONFIG_RVE<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>			<span style="color:#66d9ef">if</span> ! grep -q <span style="color:#e6db74">&#39;^CONFIG_RVE=&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>				echo <span style="color:#e6db74">&#34;CONFIG_RVE=y&#34;</span> &gt;&gt; <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>			<span style="color:#66d9ef">fi</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		<span style="color:#66d9ef">fi</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>	@if <span style="color:#f92672">[</span> -f <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		cp <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H_BK<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_TARGET_NATIVE_ELF/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_TRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_ITRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_MTRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_FTRACE/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_EXPR_TEST/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_DIFFTEST/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		sed -i <span style="color:#e6db74">&#39;/^#define CONFIG_ISA/d&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		echo <span style="color:#e6db74">&#34;#define CONFIG_ISA \&#34;riscv32\&#34;&#34;</span> &gt;&gt; <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		echo <span style="color:#e6db74">&#34;#define CONFIG_ISA_riscv 1&#34;</span> &gt;&gt; <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>CONFIG_RVE<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>			<span style="color:#66d9ef">if</span> ! grep -q <span style="color:#e6db74">&#39;^#define CONFIG_RVE&#39;</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>				echo <span style="color:#e6db74">&#34;#define CONFIG_RVE 1&#34;</span> &gt;&gt; <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>			<span style="color:#66d9ef">fi</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		<span style="color:#66d9ef">fi</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">restore-nemu</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	@echo <span style="color:#e6db74">&#34;Restoring NEMU config files...&#34;</span>
</span></span><span style="display:flex;"><span>	@if <span style="color:#f92672">[</span> -f <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF_BK<span style="color:#66d9ef">)</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		mv <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF_BK<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>NEMU_AUTO_CONF<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>	@if <span style="color:#f92672">[</span> -f <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H_BK<span style="color:#66d9ef">)</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		mv <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H_BK<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>NEMU_AUTOCONF_H<span style="color:#66d9ef">)</span>; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>	<span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ifdef</span> <span style="color:#960050;background-color:#1e0010">CONFIG_DIFFTEST_REF_NEMU</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$(DIFF_REF_SO)</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	@<span style="color:#66d9ef">$(</span>MAKE<span style="color:#66d9ef">)</span> backup-nemu
</span></span><span style="display:flex;"><span>	@<span style="color:#66d9ef">$(</span>MAKE<span style="color:#66d9ef">)</span> -s -C <span style="color:#66d9ef">$(</span>DIFF_REF_PATH<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>MKFLAGS<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>	@<span style="color:#66d9ef">$(</span>MAKE<span style="color:#66d9ef">)</span> restore-nemu
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>DIFF_REF_SO<span style="color:#66d9ef">)</span> backup-nemu restore-nemu
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">endif</span>
</span></span></code></pre></div><p>该Makefile的基本结构参考了<code>nemu/tools/difftest.mk</code>，其中<code>DIFF_REF_SO</code>即为REF的动态库文件，当将该Makefile包含在主Makefile中，即可通过：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#a6e22e">run</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>VERILOG_INPUT<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>VRC_INPUT<span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ifdef</span> <span style="color:#960050;background-color:#1e0010">CONFIG_DIFFTEST</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">@echo</span> <span style="color:#e6db74">&#34;-------- REF COMPILE ---------&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#66d9ef">$(</span>MAKE<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>DIFF_REF_SO<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">endif</span>
</span></span></code></pre></div><p>调用并构建NEMU的动态库文件。以下，我们将解释该Makefile是如何实现对NEMU的配置及恢复的，这主要包括两方面：</p>
<p>首先，在<code>DIFF_REF_SO</code>的<code>MKFLAGS</code>中，我们将通过Makfile传递NEMU的<code>GUEST_ISA</code>、<code>SHARE</code>与<code>ENGINE</code>参数。此处设置<code>SHARE=1</code>，NEMU便会自动编译成动态库文件。</p>
<p>其次，当NEMU作为REF时，我们需要除能NEMU配置中一些非必要的功能，比如itrace、ftrace、mtrace等，因为这些功能本身具有输出功能，如果编译动态库文件中包含这些功能，在NPC中运行DiffTest时将会混杂NEMU的输出，造成功能异常。</p>
<p>为此，我们定义了<code>backup-nemu</code>与<code>restore-nemu</code>两个目标，前者用于将NEMU通过Kconfig生成的配置文件（<code>autoconf.h</code>与<code>auto.conf</code>）保存为副本，并修改配置文件的配置项；后者则用于将副本重新加载为NEMU配置文件。在<code>backup-nemu</code>中，我们修改的配置主要包括：</p>
<ul>
<li>除能<code>CONFIG_TARGET_NATIVE_ELF</code>，保证NEMU编译成动态库文件，此处之所以没有补充定义<code>CONFIG_TARGET_SHARE</code>，是因为定义该配置的效果完全等同于在构建时传递<code>SHARE=1</code>。</li>
<li>除能NEMU的指令集架构，将其统一设置为RISCV32，这使得即使我们没有使用RISCV32架构的NEMU，仍然可以在NPC中成功编译RISCV32架构的NEMU动态库文件。</li>
<li>除能NEMU的itrace，mtrace，ftrace功能。</li>
<li>除能NEMU的sdb表达式求值测试功能。</li>
<li>当NPC指令集架构为RV32E，在NEMU中补充定义<code>CONFIG_RVE</code>，将其指令集架构修改为RV32E。</li>
</ul>
<h3 id="4-difftest的时序问题">4. DiffTest的时序问题</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">trace_and_difftest</span>(Vtop <span style="color:#f92672">*</span>top) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_ITRACE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  log_write(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, logbuf);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (g_print_step) { IFDEF(CONFIG_ITRACE, puts(logbuf)); }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_DIFFTEST
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pc_get(<span style="color:#f92672">&amp;</span>pc_d, <span style="color:#f92672">&amp;</span>dnpc_d); load_cpu(top);
</span></span><span style="display:flex;"><span>  difftest_step((vaddr_t)pc_d, (vaddr_t)dnpc_d); <span style="color:#75715e">// current-cycle difftest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exec_once</span>(Vtop <span style="color:#f92672">*</span>top, VerilatedContext <span style="color:#f92672">*</span>contextp, VerilatedFstC <span style="color:#f92672">*</span>tfp, <span style="color:#66d9ef">bool</span> rst) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (rst) {
</span></span><span style="display:flex;"><span>    EDGE_TRG_EVENT(top, top<span style="color:#f92672">-&gt;</span>rst <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; top<span style="color:#f92672">-&gt;</span>inst <span style="color:#f92672">=</span> vaddr_ifetch(top<span style="color:#f92672">-&gt;</span>inst_addr, <span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_ITRACE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  IRingBuffer_write(top);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  half_cycle(top, contextp, tfp);
</span></span><span style="display:flex;"><span>  EDGE_TRG(top);
</span></span><span style="display:flex;"><span>  half_cycle(top, contextp, tfp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_FTRACE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> type_ft;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> pc_ft, dnpc_ft;
</span></span><span style="display:flex;"><span>  ftrace_type(<span style="color:#f92672">&amp;</span>type_ft); pc_get(<span style="color:#f92672">&amp;</span>pc_ft, <span style="color:#f92672">&amp;</span>dnpc_ft);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (type_ft) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> print_call((vaddr_t)pc_ft, (vaddr_t)dnpc_ft, false); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> print_return((vaddr_t)pc_ft); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span> print_call((vaddr_t)pc_ft, (vaddr_t)dnpc_ft, true); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_ITRACE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> logbuf;
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">+=</span> snprintf(p, MAX_LOGBUF_LEN, FMT_WORD <span style="color:#e6db74">&#34;:&#34;</span>, top<span style="color:#f92672">-&gt;</span>inst_addr);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>inst <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>top<span style="color:#f92672">-&gt;</span>inst;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">+=</span> snprintf(p, <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34; %02x&#34;</span>, inst[i]);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  memset(p, <span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#ae81ff">1</span>); p <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> disassemble(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str, <span style="color:#66d9ef">int</span> size, <span style="color:#66d9ef">uint64_t</span> pc, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>code, <span style="color:#66d9ef">int</span> nbyte);
</span></span><span style="display:flex;"><span>  disassemble(p, logbuf <span style="color:#f92672">+</span> MAX_LOGBUF_LEN <span style="color:#f92672">-</span> p, top<span style="color:#f92672">-&gt;</span>inst_addr, (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>top<span style="color:#f92672">-&gt;</span>inst, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  EDGE_TRG_EVENT(top, top<span style="color:#f92672">-&gt;</span>inst <span style="color:#f92672">=</span> vaddr_ifetch(top<span style="color:#f92672">-&gt;</span>inst_addr, <span style="color:#ae81ff">4</span>)); <span style="color:#75715e">// next instruction fetch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>由于我们采用自定义的宏<code>EDGE_TRG_EVENT()</code>来实现对Verilator生成文件的激励，这会在实现DiffTest时带来一些时序问题，具体而言：NPC中定义的<code>exec_once()</code>函数实际上仿真的是从当前时钟周期时钟上升沿开始，到下一时钟周期上升沿前的时间，这使得当该函数执行完成，当前指令还没有对寄存器堆进行写回操作（这需要等到下一时钟上升沿后），寄存器堆内部的取值还没有更新，因此，如果像NEMU中，在<code>exec_once()</code>执行完成后直接进行DiffTest，便会引发错误。</p>
<p>为此，我们调整了<code>exec_once()</code>函数的执行顺序，将其仿真的时间修改为从当前时钟周期时钟上升沿后开始，到下一时钟上升沿后结束，即在<code>exec_once()</code>函数中会预取下一周期的指令。同时，我们需要额外保证在系统复位后，<code>exec_once()</code>函数中也会预取第一周期的指令。</p>
    </div>
</div>

            </main>
        </div>


        <footer class="footer">
    
        <span>
            © 2025 Posvirus&#39; Blog, Built with
            <a href="https://gohugo.io" class="footerLink">Hugo</a> and
            <a href="https://github.com/LordMathis/hugo-theme-nightfall" class="footerLink">Nightfall</a> theme
        </span>
    
</footer>
    </div>

</body>

</html>